name: C Build & Test (Windows)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch: # allows manual run

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Install MSYS2 and GCC
      - name: Install MSYS2 and GCC
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: mingw-w64-x86_64-gcc make

      # 3. Add GCC to PATH for workflow
      - name: Add GCC to PATH
        run: $env:PATH += ";C:\msys64\mingw64\bin"

      # 4. Verify GCC
      - name: Verify GCC
        run: gcc --version

      # 5. Build all .c files recursively
      # 5. Build all .c files recursively (relative paths)
      - name: Build C project
        run: |
            # Ensure PATH is available
              $env:PATH += ";C:\msys64\mingw64\bin"

      # Create build directory
       mkdir build

        # Collect all .c files recursively in repo, convert to relative paths
          $files = Get-ChildItem -Recurse -Filter *.c | ForEach-Object {
          $_.FullName.Replace("$pwd\", ".\")
        }

        # Debug: show files being compiled
        Write-Host "Compiling files:"
         $files | ForEach-Object { Write-Host $_ }

    # Compile all files
       gcc -Wall -Werror -o build\my_program @($files)


      # 6. List build folder for verification
      - name: List build folder
        run: dir build

      # 7. Run program in test mode
      - name: Run tests
        run: build\my_program --test
